;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="7284a8e9-fe32-0f0d-bfe4-babb4c695900")}catch(e){}}();
(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,866684,357170,828684,e=>{"use strict";e.s(["default",()=>R,"useWorkflowContext",()=>j],866684);var t=e.i(843476),o=e.i(271645),r=e.i(52563),n=e.i(618566),a=e.i(604570),i=e.i(846696),l=e.i(982926),s=e.i(384347),u=e.i(562920),c=e.i(796610),d=e.i(367944),f=e.i(210677),p=e.i(653770),w=e.i(620949),_=e.i(414571),h=e.i(709557),v=e.i(268580),y=e.i(544216),m=e.i(889435),g=e.i(842405),k=e.i(11573),S=e.i(720858);let b=({workflowId:e})=>{let{getAccessTokenSilently:t}=(0,r.useAuth0)(),{isFreeUser:n,setModal:l}=(0,d.useChatContext)(),{data:s}=(0,y.useConnectors)(),u=(0,_.default)(e=>e.addToQueue),c=(0,_.default)(e=>e.activeStepId),f=(0,h.default)(e=>e.sendData),p=window.location.href?.includes("team")?"team":"personal",w=(0,o.useCallback)(e=>{let t=n&&e.length>1;return t&&(l("subscribe"),a.default.capture("upgrade_cta_shown",{type:"modal",name:"multiple_files",location:"notebook_file_picker"}),"function"==typeof window.gtag&&(window.gtag("event","multiple_files_upgrade_cta_shown"),(0,k.trackLinkedInConversion)(k.UPGRADE_MODAL_SHOWN))),t},[n,l]),b=(0,o.useCallback)(async({stepId:o,queuedAt:r,attachments:n,connections:a,uploadStarted:i=!1})=>{let l=h.default.getState(),{workflowConversationId:s,activeStepId:u}=_.workflowEngine.getState(),c=v.workflowService.getStepById(e,o),d=v.workflowService.getCellType(c),p=await t();l.isConnected&&(u===o&&c.status===S.WorkflowCellStatus.RUNNING?n||a?f("message_cell",{workflow_id:e,workflow_step_id:o,message:{attachments:n||void 0,connections:a||void 0}}):i&&f("message_cell",{workflow_id:e,workflow_step_id:o,message:{upload_started:i}}):c.status!==S.WorkflowCellStatus.QUEUED&&l.sendData("queue_cell",{workflow_id:e,queued_at:r,workflow_conversation_id:s,workflow_step_id:o,access_token:p,cell_type:d.value,data:{upload_started:!!n||i,attachments:n||void 0,connections:a||void 0}}))},[t,f,e]),C=(0,o.useCallback)(async e=>{let o=await t();return{name:(await (0,m.uploadMultipartFile)({accessToken:o,file:e,filename:e.name})).filename,size:e.size}},[t]),A=(0,o.useCallback)(async e=>{let o=await t(),{workflowConversationId:r}=_.workflowEngine.getState();try{let{signedUrl:t,filename:n}=await (0,m.getSignedFileUploadUrl)({accessToken:o,filename:e.name,fileType:e.type,useTeamServer:"team"===p});return await (0,m.uploadToSignedUrl)({signedUrl:t,file:e,filename:n,contentType:e.type,onProgress:(e,t,o)=>{}}),await (0,m.transferFile)(n,!1,r,o),g.client.invalidateQueries({queryKey:["files"]}),{name:n,size:e.size}}catch(t){return await C(e)}},[C,t,p]),I=(0,o.useCallback)(async(e,t,o)=>{if(0!==e.length||0!==t.length){if(w(e))return void(0,_.cancelRunCell)(o);try{let r={stepId:o,queuedAt:(0,_.getUniqueTimestamp)(),attachments:void 0,connections:void 0};if(e&&(r.attachments=e.reduce((e,t)=>({...e,[t.name]:{type:"file",name:t.name,size:t.size}}),{})),t){if(!s)throw Error("Connectors not found");r.connections=t.reduce((e,t)=>{let o=s.find(e=>e.id===t.type);return{...e,[t.name]:{type:"connection",ext:o.name,id:t.id,connector_id:t.type,name:t.name}}},{})}await b(r)}catch(e){console.error(e),(0,_.cancelRunCell)(o)}}},[s,w,b]),O=(0,o.useCallback)(async(t,o)=>{if(0!==t.length&&!w(t)){void 0===c&&u(o);try{await b({stepId:o,attachments:void 0,uploadStarted:!0,queuedAt:(0,_.getUniqueTimestamp)()});let e=t.map(e=>A(e)),r=(await Promise.all(e)).reduce((e,t)=>(e[t.name]={name:t.name,size:t.size},e),{});await b({stepId:o,attachments:r,queuedAt:(0,_.getUniqueTimestamp)()})}catch(n){console.error(n),i.toast.error("Failed to upload file.",{description:"Please try again."});let{errorCell:r}=_.workflowEngine.getState();(0,_.cancelRunCell)(o),r(o),a.default.capture("workflow:cell:new_file_upload_error",{workflowId:e,error:JSON.stringify(n),files:t.map(e=>({name:e.name,size:e.size}))})}}},[c,u,w,b,A,e]);return{submitFilePrompt:b,selectNewFile:O,selectExistingFiles:I}};e.s(["default",0,b],357170),e.s(["default",()=>T],828684);var C=e.i(531278),A=e.i(586011),I=e.i(471512),O=e.i(356886),E=e.i(167881),P=e.i(630374);let T=({children:e,interceptor:a,setInterceptor:i,asChild:l})=>{let{isAuthenticated:s}=(0,r.useAuth0)(),[u,c]=(0,o.useState)({open:!1,cellId:void 0}),{accessRole:d,mode:f,teamId:p,workflowId:w}=j(),_=(0,n.useRouter)(),{mutateAsync:h,isPending:v}=(0,I.useDuplicateWorkflow)({teamId:p}),y=(0,o.useCallback)(async()=>{let e;if("editor"===d&&"template"===f)e=await h({workflowId:w,type:"child"});else{let t=await h({workflowId:w,type:"parent"});e=await h({workflowId:t.id,type:"child"})}if(a?.cellId){let t=a.cellId;_.push(`/notebooks/${e.id}${t?`?cell=${t}`:""}`)}else _.push(`/notebooks/${e.id}?cell=all`)},[d,a,h,f,_,w]);return(0,t.jsxs)(P.Dialog,{open:a?.open||u?.open,onOpenChange:e=>{e||(i?.({open:!1,cellId:void 0}),c({open:!1,cellId:void 0}))},children:[l?(0,t.jsx)(A.Slot.Root,{onClick:e=>{e.defaultPrevented&&c({open:!0,cellId:void 0})},children:e}):e,(0,t.jsxs)(P.DialogContent,{className:"max-w-[450px]",onOpenAutoFocus:e=>{e.preventDefault()},children:[(0,t.jsx)(P.DialogTitle,{className:"inline-flex gap-1 text-2xl font-semibold",children:s?"Start Notebook":"Welcome to Julius"}),(0,t.jsx)(P.DialogDescription,{className:"text-muted-foreground text-sm",children:s?"viewer"===d?"Running this cell will create your own copy of the notebook. Would you like to continue?":"editor"===d?"The owner must be present to run the notebook. Instead, You can create your own copy of the notebook now. Would you like to continue?":"":"You must log in to run this notebook."}),(0,t.jsxs)("div",{className:"flex gap-2 mt-4 justify-end",children:[(0,t.jsx)(P.DialogClose,{asChild:!0,children:(0,t.jsx)(E.Button,{variant:"ghost",size:"sm",children:"Cancel"})}),s?(0,t.jsx)(E.Button,{size:"sm",onClick:y,disabled:v,children:v?(0,t.jsx)(C.Loader2,{className:"size-4 animate-spin"}):"Create notebook"}):(0,t.jsx)(O.UserProfileSignUpButton,{returnTo:window.location.pathname})]})]})]})};var D=e.i(442706);let N=(0,o.createContext)(void 0),j=()=>{let e=(0,o.useContext)(N);if(void 0===e)throw Error("useWorkflowContext must be used within a WorkflowProvider");return e},R=({children:e,workflowId:y,teamId:m})=>{let g=(0,n.useRouter)(),{user:k}=(0,r.useAuth0)(),C=(0,n.usePathname)(),{setModal:A}=(0,p.useModal)(),I=(0,n.useSearchParams)(),O=(0,o.useRef)(null),{setActiveConversationId:E,setIsGenerating:P}=(0,d.useChatContext)(),{updateMessages:j}=(0,f.useMessageContext)(),[R,x]=(0,o.useState)({open:!1,cellId:void 0}),{getAccessTokenSilently:F}=(0,r.useAuth0)(),{data:U}=(0,c.useCurrentTeam)(),{data:L}=(0,l.useWorkflowSharing)({workflowId:y}),{mutateAsync:W}=(0,l.useUpdateWorkflowPlan)({workflowId:y}),{data:q}=(0,w.useUserSubscription)(),{data:z}=(0,u.useWorkflowGroupShares)(y),{data:Q,isSuccess:M}=(0,l.useWorkflowQuery)({workflowId:y}),{submitAgentPrompt:B}=(({workflowId:e})=>{let t=_.default.use.resetCell(),n=_.default.use.interruptCell(),{getAccessTokenSilently:a}=(0,r.useAuth0)();return{submitAgentPrompt:(0,o.useCallback)(async({stepId:o,queuedAt:r,mode:l="auto"})=>{try{let t=h.default.getState(),{workflowConversationId:n}=_.workflowEngine.getState(),i=v.workflowService.getStepById(e,o),s=v.workflowService.getCellType(i),u=await a();t.isConnected&&t.sendData("queue_cell",{workflow_id:e,queued_at:r,workflow_conversation_id:n,workflow_step_id:o,access_token:u,cell_type:s.value,data:{access_token:u,workflow_id:e,workflow_step_id:o,chat_mode:"auto",plan_step_id:o,message:{content:i.display,..."user-code"===s.value?{code_language:i.content,code_connection_id:i.display_prompt,code_df_name:i.metadata?.code_df_name??void 0}:{},planId:e,mode:l,plan_step_id:o,workflow_step_for:"assistant"},client_version:"20240130"}})}catch(r){let e=v.workflowService.parseWorkflowError(r);i.toast.error("Oops! Failed to execute cell.",{description:e}),n(o),t(o)}},[n,t,e,a])}})({workflowId:y}),{submitEvalPrompt:K}=(({workflowId:e})=>{let t=_.default.use.resetCell(),n=_.default.use.interruptCell(),{getAccessTokenSilently:a}=(0,r.useAuth0)();return{submitEvalPrompt:(0,o.useCallback)(async({stepId:o,queuedAt:r})=>{try{let t=h.default.getState(),{workflowConversationId:n}=_.workflowEngine.getState(),i=v.workflowService.getStepById(e,o),l=v.workflowService.getCellType(i),s=await a();t.isConnected&&t.sendData("queue_cell",{workflow_id:e,queued_at:r,workflow_conversation_id:n,workflow_step_id:o,access_token:s,cell_type:l.value,data:{access_token:s,workflow_id:e,workflow_step_id:o,chat_mode:"auto",plan_step_id:o,message:{content:i.display,planId:e,mode:"evaluation",plan_step_id:o,workflow_step_for:"evaluation",evaluation_type:i?.metadata?.evaluation_type??"qualitative",send_to_slack:i?.metadata?.send_to_slack??!1},client_version:"20240130"}})}catch(r){let e=v.workflowService.parseWorkflowError(r);i.toast.error("Oops! Failed to execute evaluation.",{description:e}),n(o),t(o)}},[n,t,e,a])}})({workflowId:y}),$=C.includes("/s/"),J=Q?.is_template,V=Q?.conversation_id,{submitUserPrompt:G}=(({workflowId:e})=>{let{getAccessTokenSilently:t}=(0,r.useAuth0)(),n=_.default.use.activeStepId(),a=(0,h.default)(e=>e.sendData);return{submitUserPrompt:(0,o.useCallback)(async({stepId:o,queuedAt:r})=>{if(e){let i=await t(),l=h.default.getState(),{workflowConversationId:s}=_.workflowEngine.getState(),u=v.workflowService.getStepById(e,o),c=v.workflowService.getCellType(u);l.isConnected&&(n===o&&u.status===S.WorkflowCellStatus.RUNNING?a("message_cell",{workflow_id:e,workflow_step_id:o,message:{content:u.content}}):l.sendData("queue_cell",{workflow_id:e,queued_at:r,workflow_conversation_id:s,workflow_step_id:o,access_token:i,cell_type:c.value,data:{}}))}},[n,t,a,e])}})({workflowId:y}),{submitFilePrompt:H}=b({workflowId:y}),{submitSqlEditorPrompt:X}=(({workflowId:e})=>{let t=_.default.use.resetCell(),n=_.default.use.interruptCell(),{getAccessTokenSilently:a}=(0,r.useAuth0)();return{submitSqlEditorPrompt:(0,o.useCallback)(async({stepId:o,queuedAt:r})=>{try{let t=h.default.getState(),{workflowConversationId:n}=_.workflowEngine.getState(),l=v.workflowService.getStepById(e,o);if(!l)return;if(!n)return void i.toast.error("Missing notebook conversation. Please reopen the notebook and try again.");if(!l.display_prompt)return void i.toast.error("Select a data connector for this cell before running it.");if(!l.display?.trim())return void i.toast.error("Add a prompt so Julius knows what SQL to generate.");if(t.isConnected){let i=await a(),s=v.workflowService.getCellType(l),u={access_token:i,workflow_id:e,workflow_step_id:o,workflow_conversation_id:n,conversation_id:n,plan_step_id:o,chat_mode:"sql-editor",client_version:"20240130",connection_id:l.display_prompt,prompt:l.display,current_window:l.metadata?.sql_editor_query??void 0,transient_conversation:!0,message:{content:l.display,planId:e,plan_step_id:o,workflow_step_for:"assistant",mode:"sql-editor"}};t.sendData("queue_cell",{workflow_id:e,queued_at:r,workflow_conversation_id:n,workflow_step_id:o,access_token:i,cell_type:s.value,data:u})}}catch(r){let e=v.workflowService.parseWorkflowError(r);i.toast.error("Failed to run SQL editor cell.",{description:e}),n(o),t(o)}},[a,n,t,e])}})({workflowId:y}),Y=_.default.use.activeStepId(),Z=_.default.use.runningQueue(),ee=_.default.use.initialized(),et=_.default.use.runAll(),eo=_.default.use.reset(),er=_.default.use.popQueue(),en=_.default.use.errorCell(),ea=_.default.use.completeCell(),ei=_.default.use.interruptCell(),el=(0,h.default)(e=>e.socket),es=(0,h.default)(e=>e.isConnected),eu=(0,h.default)(e=>e.on),ec=(0,h.default)(e=>e.connect),ed=(0,h.default)(e=>e.reset),ef=_.default.use.cellCount(),ep=v.workflowService.getIsOwner(Q,k),ew=v.workflowService.getAcessRole(Q,L,k,U,z),e_=!q?.status&&!U?.paid;(0,o.useEffect)(()=>{V&&E(V)},[V,E]),(0,o.useEffect)(()=>()=>{eo(),ed()},[ed,eo]),(0,o.useEffect)(()=>{let e=()=>{es||"visible"!==document.visibilityState||ec(F,y)};return document.addEventListener("visibilitychange",e),()=>{document.removeEventListener("visibilitychange",e)}},[es,F,ec,y]),(0,o.useEffect)(()=>{M&&!es&&ec(F,y)},[ec,F,es,M,y]),(0,o.useEffect)(()=>{if(!el)return;let{_updateCells:e,setActiveStepId:t}=_.workflowEngine.getState(),o=eu("stream_end",e=>{if("errored"===e.status){try{let t=JSON.parse(e.message);t?.error&&("rate_limit"===t.error?q?.plan==="Lite"?(A("lite_upgrade"),a.default.capture("upgrade_cta_shown",{type:"modal",name:"lite_upgrade"})):(A("subscribe"),a.default.capture("upgrade_cta_shown",{type:"modal",name:"subscribe"})):"owner_not_in_room"===t.error?i.toast.error("Cannot run cell, the owner has closed the workflow."):i.toast.error("Oops! Failed to execute cell.",{description:t.error}))}catch(t){403===e.status_code?x({open:!0,cellId:e.workflow_step_id}):i.toast.error("Oops! Failed to execute cell.",{description:e.message})}en(e.workflow_step_id)}else"completed"===e.status?ea(e.workflow_step_id):"interrupted"===e.status&&ei(e.workflow_step_id);P(!1)}),r=eu("engine_state",e=>{"active_step_id"in e&&t(e?.active_step_id)}),n=eu("edit",({patch:t,plan:o})=>{if(o)(0,_.mutatePlan)(()=>o,{sync:!1});else if(t){let r=v.workflowService.getWorkflow(y);o=D.diffEngine.apply(structuredClone(r.plan),t),(0,_.mutatePlan)(()=>o,{sync:!1}),e(o.steps)}});return()=>{el&&(o(),r(),n())}},[ea,en,ei,eu,P,A,el,q,y]);let eh=(0,o.useMemo)(()=>J?"template":"run",[J]);(0,o.useEffect)(()=>{if(el)return eu("stream_result",e=>{let{activeStepId:t}=_.workflowEngine.getState();if(e?.status=="interrupted"&&(P(!1),t&&ei(t)),e?.status==="errored"&&(i.toast.error("Server Error: Generating message failed.",{description:e?.error}),t&&ei(t),P(!1)),e?.message&&e?.conversation_id){let{status:t,message:o,conversation_id:r}=e,n=JSON.parse(o);"errored"!==t&&"interrupted"!==t&&P(!0),j(n,r)}})},[ei,eu,P,A,j,el]);let ev=(0,o.useCallback)(e=>{let{workflowId:t}=_.workflowEngine.getState(),{isConnected:o}=h.default.getState(),r=v.workflowService.getStepById(t,e);if(!r)return;let n=v.workflowService.getCellType(r);if("markdown"===n.value)return;if("viewer"===ew)return x({open:!0,cellId:e});if(!o)return v.workflowService.disconnectedToast();let a=(0,_.getUniqueTimestamp)();if("ai-prompt"===n.value)B({stepId:e,queuedAt:a});else if("user-code"===n.value)B({stepId:e,queuedAt:a,mode:"code"});else if("file-upload"===n.value){let{preloadedAttachments:t,preloadAttachments:o}=_.workflowEngine.getState();Object.keys(t??{}).length>0&&(H({stepId:e,queuedAt:a,attachments:t}),o(void 0))}else"user-prompt"===n.value?G({stepId:e,queuedAt:a}):"eval-prompt"===n.value?K({stepId:e,queuedAt:a}):"sql-editor-prompt"===n.value&&X({stepId:e,queuedAt:a})},[ew,B,K,H,X,G]);(0,o.useEffect)(()=>{if(Z.length>0&&es){let e=setTimeout(()=>{er(),ev(Z.at(0))},100);return()=>clearTimeout(e)}},[Y,es,er,ev,Z]);let ey=I.get("cell");if(ey&&Q&&ee&&el&&es)try{"all"===ey?et({from:"previous"}):ev(ey)}catch(e){}finally{let e=new URLSearchParams(I.toString());e.delete("cell"),g.push(`?${e.toString()}`)}let em=Q?.plan?.steps.every(e=>e?.status===S.WorkflowCellStatus.COMPLETED||e.role===s.WorkflowRole.markdown)&&Q?.plan?.steps?.length>0,eg=(0,o.useMemo)(()=>({virtuoso:O,accessRole:ew,workflowId:y,teamId:m,cellCount:ef,mode:eh,workflowConversationId:V,isShared:$,runCell:ev,allStepsComplete:em,isOwner:ep,isConnected:es,isFreeUser:e_}),[ew,em,ef,ep,es,$,eh,ev,m,V,y,e_]);return(0,t.jsx)(N.Provider,{value:eg,children:(0,t.jsx)(T,{interceptor:R,setInterceptor:x,children:e})})}},709557,442706,e=>{"use strict";var t,o=e.i(846696),r=e.i(768834),n=e.i(842405),a=e.i(394073);let i={socket:null,workflowId:void 0,getAccessTokenSilently:void 0,isConnected:!1,presences:[],isConnecting:!1,firstConnection:!0},l=(0,r.create)((t,r)=>({...i,reset:()=>{r().disconnect(),t(i)},connect:async(i,l)=>{let{socket:s,workflowId:u}=r();if(t({getAccessTokenSilently:i}),s?.connected&&u===l)return;s&&s.disconnect();let c=await e.A(622025).then(e=>e.io);t({isConnected:!1,isConnecting:!0});let d=await i(),f=c(`${a.SOCKET_URL}/workflows`,{path:"/ws",transports:["websocket","polling"],auth:{token:d,workflowId:l},reconnectionDelay:500,reconnectionAttempts:1/0});t({socket:f}),f.on("connect",()=>{t({isConnected:!0,isConnecting:!1,firstConnection:!1})}),f.on("connect_error",async e=>{let o=e.data?.code,n=e.data?.description??e.message??"";if(401===o||n.toLowerCase().includes("token is expired"))try{let{getAccessTokenSilently:e}=r();if(e){let t=await e();f.auth={...f.auth,token:t},f.disconnected&&f.connect();return}}catch(e){console.warn("[workflows] failed to refresh token on connect_error:",e)}t({isConnected:!1,isConnecting:!1,firstConnection:403===o})}),f.on("reconnect",()=>{console.warn("reconnect success"),t({isConnected:!0,isConnecting:!1})}),f.on("reconnect_attempt",async e=>{console.warn("reconnect attempt, count: ",e);let{socket:o,getAccessTokenSilently:n}=r();n&&(o.auth.token=await n()),t({isConnected:!1,isConnecting:!0})}),f.on("reconnect_failed",e=>{console.warn("reconnect failed, reason:",e),t({isConnected:!1,isConnecting:!1})}),f.on("disconnect",()=>{t({isConnected:!1})}),f.on("presence",e=>{t({presences:e||[]})}),f.on("owner_left",()=>{o.toast.error("The owner has left the notebook; create a new notebook to continue working or wait for them to rejoin.")}),f.on("error",e=>{let t=e?.title||"Unexpected error",r=e?.message||JSON.stringify(e);o.toast.error(t,{description:r})}),f.on("clear_cell",({success:e,conversation_id:t,workflow_step_id:o})=>{e&&n.client.setQueryData(["conversation/messages",t],e=>e?.filter(e=>e.plan_step_id!==o))})},disconnect:()=>{let{socket:e}=r();e&&(e.disconnect(),t({socket:null,isConnected:!1}))},sendData:(e,t)=>{let{socket:o,isConnected:n}=r();return!!o&&!!n&&(o.emit(e,t),!0)},on:(e,t)=>{let{socket:o}=r();return o&&(o.off(e,t),o.on(e,t)),()=>{let{socket:o}=r();o&&o.off(e,t)}}}));e.s(["default",0,l],709557);var s=(t=function(e,o){return(t=Object.setPrototypeOf||({__proto__:[]})instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])})(e,o)},function(e,o){function r(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(r.prototype=o.prototype,new r)}),u=Object.prototype.hasOwnProperty;function c(e,t){return u.call(e,t)}function d(e){if(Array.isArray(e)){for(var t=Array(e.length),o=0;o<t.length;o++)t[o]=""+o;return t}if(Object.keys)return Object.keys(e);var r=[];for(var n in e)c(e,n)&&r.push(n);return r}function f(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function p(e){for(var t,o=0,r=e.length;o<r;){if((t=e.charCodeAt(o))>=48&&t<=57){o++;continue}return!1}return!0}function w(e){return -1===e.indexOf("/")&&-1===e.indexOf("~")?e:e.replace(/~/g,"~0").replace(/\//g,"~1")}function _(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function h(e,t){var o=[e];for(var r in t){var n="object"==typeof t[r]?JSON.stringify(t[r],null,2):t[r];void 0!==n&&o.push(r+": "+n)}return o.join("\n")}var v=function(e){function t(t,o,r,n,a){var i=this.constructor,l=e.call(this,h(t,{name:o,index:r,operation:n,tree:a}))||this;return l.name=o,l.index=r,l.operation=n,l.tree=a,Object.setPrototypeOf(l,i.prototype),l.message=h(t,{name:o,index:r,operation:n,tree:a}),l}return s(t,e),t}(Error),y={add:function(e,t,o){return e[t]=this.value,{newDocument:o}},remove:function(e,t,o){var r=e[t];return delete e[t],{newDocument:o,removed:r}},replace:function(e,t,o){var r=e[t];return e[t]=this.value,{newDocument:o,removed:r}},move:function(e,t,o){var r=g(o,this.path);r&&(r=f(r));var n=k(o,{op:"remove",path:this.from}).removed;return k(o,{op:"add",path:this.path,value:n}),{newDocument:o,removed:r}},copy:function(e,t,o){var r=g(o,this.from);return k(o,{op:"add",path:this.path,value:f(r)}),{newDocument:o}},test:function(e,t,o){return{newDocument:o,test:I(e[t],this.value)}},_get:function(e,t,o){return this.value=e[t],{newDocument:o}}},m={add:function(e,t,o){return p(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:o,index:t}},remove:function(e,t,o){return{newDocument:o,removed:e.splice(t,1)[0]}},replace:function(e,t,o){var r=e[t];return e[t]=this.value,{newDocument:o,removed:r}},move:y.move,copy:y.copy,test:y.test,_get:y._get};function g(e,t){if(""==t)return e;var o={op:"_get",path:t};return k(e,o),o.value}function k(e,t,o,r,n,a){if(void 0===o&&(o=!1),void 0===r&&(r=!0),void 0===n&&(n=!0),void 0===a&&(a=0),o&&("function"==typeof o?o(t,0,e,t.path):C(t,0)),""===t.path){var i={newDocument:e};if("add"===t.op)return i.newDocument=t.value,i;if("replace"===t.op)return i.newDocument=t.value,i.removed=e,i;if("move"===t.op||"copy"===t.op)return i.newDocument=g(e,t.from),"move"===t.op&&(i.removed=e),i;else if("test"===t.op){if(i.test=I(e,t.value),!1===i.test)throw new v("Test operation failed","TEST_OPERATION_FAILED",a,t,e);return i.newDocument=e,i}else if("remove"===t.op)return i.removed=e,i.newDocument=null,i;else if("_get"===t.op)return t.value=e,i;else if(!o)return i;else throw new v("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",a,t,e)}r||(e=f(e));var l=(t.path||"").split("/"),s=e,u=1,c=l.length,d=void 0,w=void 0,h=void 0;for(h="function"==typeof o?o:C;;){if((w=l[u])&&-1!=w.indexOf("~")&&(w=_(w)),n&&("__proto__"==w||"prototype"==w&&u>0&&"constructor"==l[u-1]))throw TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(o&&void 0===d&&(void 0===s[w]?d=l.slice(0,u).join("/"):u==c-1&&(d=t.path),void 0!==d&&h(t,0,e,d)),u++,Array.isArray(s)){if("-"===w)w=s.length;else if(o&&!p(w))throw new v("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",a,t,e);else p(w)&&(w=~~w);if(u>=c){if(o&&"add"===t.op&&w>s.length)throw new v("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",a,t,e);var i=m[t.op].call(t,s,w,e);if(!1===i.test)throw new v("Test operation failed","TEST_OPERATION_FAILED",a,t,e);return i}}else if(u>=c){var i=y[t.op].call(t,s,w,e);if(!1===i.test)throw new v("Test operation failed","TEST_OPERATION_FAILED",a,t,e);return i}if(s=s[w],o&&u<c&&(!s||"object"!=typeof s))throw new v("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",a,t,e)}}function S(e,t,o,r,n){if(void 0===r&&(r=!0),void 0===n&&(n=!0),o&&!Array.isArray(t))throw new v("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(e=f(e));for(var a=Array(t.length),i=0,l=t.length;i<l;i++)a[i]=k(e,t[i],o,!0,n,i),e=a[i].newDocument;return a.newDocument=e,a}function b(e,t,o){var r=k(e,t);if(!1===r.test)throw new v("Test operation failed","TEST_OPERATION_FAILED",o,t,e);return r.newDocument}function C(e,t,o,r){if("object"!=typeof e||null===e||Array.isArray(e))throw new v("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,o);if(y[e.op]){if("string"!=typeof e.path)throw new v("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,o);else if(0!==e.path.indexOf("/")&&e.path.length>0)throw new v('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,o);else if(("move"===e.op||"copy"===e.op)&&"string"!=typeof e.from)throw new v("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,o);else if(("add"===e.op||"replace"===e.op||"test"===e.op)&&void 0===e.value)throw new v("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,o);else if(("add"===e.op||"replace"===e.op||"test"===e.op)&&function e(t){if(void 0===t)return!0;if(t){if(Array.isArray(t)){for(var o=0,r=t.length;o<r;o++)if(e(t[o]))return!0}else if("object"==typeof t){for(var n=d(t),a=n.length,i=0;i<a;i++)if(e(t[n[i]]))return!0}}return!1}(e.value))throw new v("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,o);else if(o){if("add"==e.op){var n=e.path.split("/").length,a=r.split("/").length;if(n!==a+1&&n!==a)throw new v("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,o)}else if("replace"===e.op||"remove"===e.op||"_get"===e.op){if(e.path!==r)throw new v("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,o)}else if("move"===e.op||"copy"===e.op){var i=A([{op:"_get",path:e.from,value:void 0}],o);if(i&&"OPERATION_PATH_UNRESOLVABLE"===i.name)throw new v("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,o)}}}else throw new v("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,o)}function A(e,t,o){try{if(!Array.isArray(e))throw new v("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)S(f(t),f(e),o||!0);else{o=o||C;for(var r=0;r<e.length;r++)o(e[r],r,t,void 0)}}catch(e){if(e instanceof v)return e;throw e}}function I(e,t){if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){var o,r,n,a=Array.isArray(e),i=Array.isArray(t);if(a&&i){if((r=e.length)!=t.length)return!1;for(o=r;0!=o--;)if(!I(e[o],t[o]))return!1;return!0}if(a!=i)return!1;var l=Object.keys(e);if((r=l.length)!==Object.keys(t).length)return!1;for(o=r;0!=o--;)if(!t.hasOwnProperty(l[o]))return!1;for(o=r;0!=o--;)if(!I(e[n=l[o]],t[n]))return!1;return!0}return e!=e&&t!=t}e.s(["JsonPatchError",()=>v,"_areEquals",()=>I,"applyOperation",()=>k,"applyPatch",()=>S,"applyReducer",()=>b,"deepClone",()=>f,"getValueByPointer",()=>g,"validate",()=>A,"validator",()=>C],680643);var O=new WeakMap,E=function(e){this.observers=new Map,this.obj=e},P=function(e,t){this.callback=e,this.observer=t};function T(e,t){t.unobserve()}function D(e,t){var o=O.get(e);if(o){var r,n=o.observers.get(t);r=n&&n.observer}else o=new E(e),O.set(e,o);if(r)return r;if(r={},o.value=f(e),t){r.callback=t,r.next=null;var a=function(){N(r)},i=function(){clearTimeout(r.next),r.next=setTimeout(a)};"undefined"!=typeof window&&(window.addEventListener("mouseup",i),window.addEventListener("keyup",i),window.addEventListener("mousedown",i),window.addEventListener("keydown",i),window.addEventListener("change",i))}return r.patches=[],r.object=e,r.unobserve=function(){var e,t;N(r),clearTimeout(r.next),e=o,t=r,e.observers.delete(t.callback),"undefined"!=typeof window&&(window.removeEventListener("mouseup",i),window.removeEventListener("keyup",i),window.removeEventListener("mousedown",i),window.removeEventListener("keydown",i),window.removeEventListener("change",i))},o.observers.set(t,new P(t,r)),r}function N(e,t){void 0===t&&(t=!1);var o=O.get(e.object);j(o.value,e.object,e.patches,"",t),e.patches.length&&S(o.value,e.patches);var r=e.patches;return r.length>0&&(e.patches=[],e.callback&&e.callback(r)),r}function j(e,t,o,r,n){if(t!==e){"function"==typeof t.toJSON&&(t=t.toJSON());for(var a=d(t),i=d(e),l=!1,s=i.length-1;s>=0;s--){var u=i[s],p=e[u];if(c(t,u)&&(void 0!==t[u]||void 0===p||!1!==Array.isArray(t))){var _=t[u];"object"==typeof p&&null!=p&&"object"==typeof _&&null!=_&&Array.isArray(p)===Array.isArray(_)?j(p,_,o,r+"/"+w(u),n):p!==_&&(n&&o.push({op:"test",path:r+"/"+w(u),value:f(p)}),o.push({op:"replace",path:r+"/"+w(u),value:f(_)}))}else Array.isArray(e)===Array.isArray(t)?(n&&o.push({op:"test",path:r+"/"+w(u),value:f(p)}),o.push({op:"remove",path:r+"/"+w(u)}),l=!0):(n&&o.push({op:"test",path:r,value:e}),o.push({op:"replace",path:r,value:t}))}if(l||a.length!=i.length)for(var s=0;s<a.length;s++){var u=a[s];c(e,u)||void 0===t[u]||o.push({op:"add",path:r+"/"+w(u),value:f(t[u])})}}}function R(e,t,o){void 0===o&&(o=!1);var r=[];return j(e,t,r,"",o),r}e.s(["compare",()=>R,"generate",()=>N,"observe",()=>D,"unobserve",()=>T],228667),Object.assign({},e.i(680643),e.i(228667),{JsonPatchError:v,deepClone:f,escapePathComponent:w,unescapePathComponent:_}),e.s(["diffEngine",0,{diff:(e,t)=>R(e,t),apply:(e,t)=>S(e,t).newDocument}],442706)},982926,e=>{"use strict";var t=e.i(52563),o=e.i(954616),r=e.i(266027),n=e.i(912598),a=e.i(846696),i=e.i(614677),l=e.i(601655),s=e.i(268580),u=e.i(394073),c=e.i(647163),d=e.i(384347),f=e.i(602246);let p=async(e,t,o)=>{let r=!1,n={...e};n.name||(r=!0,n.name="Untitled Notebook"),n.steps.forEach(e=>{if(e.id||(r=!0,e.id=(0,i.v4)()),e.userInputType||(r=!0,e.userInputType=d.WorkflowInputType.text),"content"in e||(r=!0,e.content=""),!e.type){r=!0;let t=s.workflowService.getCellType(e);e.type=t.value}});try{if(r&&(await (0,l.updateWorkflowAPI)({workflowId:t,workflowPlan:e,accessToken:o})).success)return n}catch(e){console.error(e)}return e};e.s(["useRequestWorkflowAccess",0,({workflowId:e})=>{let{getAccessTokenSilently:r}=(0,t.useAuth0)(),i=(0,n.useQueryClient)();return(0,o.useMutation)({mutationKey:["workflows/request_access",e],mutationFn:async({message:t})=>{let o=await r();return await (0,l.requestWorkflowAccess)(e,o,t)},onSuccess:async()=>{a.toast.success("Access request sent"),await i.invalidateQueries({queryKey:["workflow",e]}),await i.invalidateQueries({queryKey:["workflows/sharing",e]})},onError:e=>{let t=e?.error||e?.message||"Failed to request access";a.toast.error(t)}})},"useShareWorkflow",0,({workflowId:e})=>{let{getAccessTokenSilently:r}=(0,t.useAuth0)(),a=(0,n.useQueryClient)();return(0,o.useMutation)({mutationKey:["workflows/share/update",e],mutationFn:async t=>{let o=await r(),n=`${u.BASE_API}/workflows/${e}/sharing`,i=await (0,c.customFetch)(n,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`,"X-Intentional-Action":"true"},body:JSON.stringify(t)});if(!i.ok)throw await i.json();let l=await i.json();return await a.setQueryData(["workflows/sharing",e],l),l},onSettled:(e,t)=>{a.refetchQueries({queryKey:["workflows"],exact:!1})}})},"useUpdateWorkflowPlan",0,({workflowId:e})=>{let{getAccessTokenSilently:r}=(0,t.useAuth0)(),i=(0,n.useQueryClient)(),s=(0,f.getWorkflowQueryKey)(e);return(0,o.useMutation)({mutationKey:["workflow/plan/update",e],mutationFn:async({workflowPlan:t})=>{let o=await r();return await (0,l.updateWorkflowAPI)({workflowId:e,workflowPlan:t,accessToken:o})},onMutate:async()=>(await i.cancelQueries({queryKey:s}),i.getQueryData(s)),onError:(e,t)=>{a.toast.error(e?.error||"Oops! Unable to save the workflow.",{description:"Only the creator can update the workflow."}),i.refetchQueries({queryKey:s})}})},"useWorkflowQuery",0,({workflowId:e,select:o})=>{let{getAccessTokenSilently:n,isAuthenticated:a,isLoading:i,user:s}=(0,t.useAuth0)(),u=(0,f.getWorkflowQueryKey)(e);return(0,r.useQuery)({queryKey:u,queryFn:async()=>{let t="";a&&(t=await n());let o=await (0,l.getWorkflow)(e,t);o?.plan&&(o.plan=await p(o.plan,e,t));try{if(!o.conversation_id&&o.is_template&&s.email===o.creator.email){let o=await (0,l.attachConversationToWorkflowAPI)({workflowId:e,accessToken:t});if(o)return o}}catch(e){console.error(e)}return o},staleTime:1/0,retry:!1,select:o,refetchOnWindowFocus:!1,enabled:!!e&&!i,experimental_prefetchInRender:!0,structuralSharing:!0})},"useWorkflowRuns",0,({workflowId:e,teamId:o,groupId:n,enabled:a=!0})=>{let{getAccessTokenSilently:i}=(0,t.useAuth0)();return(0,r.useQuery)({queryKey:["workflows/runs",e,o,n],queryFn:async()=>{let t=await i(),r=new URLSearchParams;o&&r.set("team_id",o),n&&r.set("group_id",n);let a=`${u.BASE_API}/workflows/${e}/runs?${r.toString()}`,l=await (0,c.customFetch)(a,{headers:{Authorization:`Bearer ${t}`,"X-Intentional-Action":"true"}});if(!l.ok)throw await l.json();return l.json()},refetchOnWindowFocus:!1,staleTime:1e4,refetchOnMount:!0,enabled:a&&!!e})},"useWorkflowSharing",0,({workflowId:e})=>{let{getAccessTokenSilently:o}=(0,t.useAuth0)();return(0,r.useQuery)({queryKey:["workflows/sharing",e],queryFn:async()=>{let t=await o(),r=`${u.BASE_API}/workflows/${e}/sharing`,n=await (0,c.customFetch)(r,{headers:{Authorization:`Bearer ${t}`,"X-Intentional-Action":"true"}});if(!n.ok)throw await n.json();return await n.json()},refetchOnWindowFocus:!1,enabled:!!e,staleTime:1/0})}])},606368,e=>{"use strict";var t,o=Symbol.for("immer-nothing"),r=Symbol.for("immer-draftable"),n=Symbol.for("immer-state");function a(e){throw Error(`[Immer] minified error nr: ${e}. Full error at: https://bit.ly/3cXEKWf`)}var i=Object.getPrototypeOf;function l(e){return!!e&&!!e[n]}function s(e){return!!e&&(d(e)||Array.isArray(e)||!!e[r]||!!e.constructor?.[r]||h(e)||v(e))}var u=Object.prototype.constructor.toString(),c=new WeakMap;function d(e){if(!e||"object"!=typeof e)return!1;let t=Object.getPrototypeOf(e);if(null===t||t===Object.prototype)return!0;let o=Object.hasOwnProperty.call(t,"constructor")&&t.constructor;if(o===Object)return!0;if("function"!=typeof o)return!1;let r=c.get(o);return void 0===r&&(r=Function.toString.call(o),c.set(o,r)),r===u}function f(e,t,o=!0){0===p(e)?(o?Reflect.ownKeys(e):Object.keys(e)).forEach(o=>{t(o,e[o],e)}):e.forEach((o,r)=>t(r,o,e))}function p(e){let t=e[n];return t?t.type_:Array.isArray(e)?1:h(e)?2:3*!!v(e)}function w(e,t){return 2===p(e)?e.has(t):Object.prototype.hasOwnProperty.call(e,t)}function _(e,t,o){let r=p(e);2===r?e.set(t,o):3===r?e.add(o):e[t]=o}function h(e){return e instanceof Map}function v(e){return e instanceof Set}function y(e){return e.copy_||e.base_}function m(e,t){if(h(e))return new Map(e);if(v(e))return new Set(e);if(Array.isArray(e))return Array.prototype.slice.call(e);let o=d(e);if(!0!==t&&("class_only"!==t||o)){let t=i(e);return null!==t&&o?{...e}:Object.assign(Object.create(t),e)}{let t=Object.getOwnPropertyDescriptors(e);delete t[n];let o=Reflect.ownKeys(t);for(let r=0;r<o.length;r++){let n=o[r],a=t[n];!1===a.writable&&(a.writable=!0,a.configurable=!0),(a.get||a.set)&&(t[n]={configurable:!0,writable:!0,enumerable:a.enumerable,value:e[n]})}return Object.create(i(e),t)}}function g(e,t=!1){return S(e)||l(e)||!s(e)||(p(e)>1&&Object.defineProperties(e,{set:k,add:k,clear:k,delete:k}),Object.freeze(e),t&&Object.values(e).forEach(e=>g(e,!0))),e}var k={value:function(){a(2)}};function S(e){return null===e||"object"!=typeof e||Object.isFrozen(e)}var b={};function C(e){let t=b[e];return t||a(0,e),t}function A(e,t){t&&(C("Patches"),e.patches_=[],e.inversePatches_=[],e.patchListener_=t)}function I(e){O(e),e.drafts_.forEach(P),e.drafts_=null}function O(e){e===t&&(t=e.parent_)}function E(e){return t={drafts_:[],parent_:t,immer_:e,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function P(e){let t=e[n];0===t.type_||1===t.type_?t.revoke_():t.revoked_=!0}function T(e,t){t.unfinalizedDrafts_=t.drafts_.length;let r=t.drafts_[0];return void 0!==e&&e!==r?(r[n].modified_&&(I(t),a(4)),s(e)&&(e=D(t,e),t.parent_||j(t,e)),t.patches_&&C("Patches").generateReplacementPatches_(r[n].base_,e,t.patches_,t.inversePatches_)):e=D(t,r,[]),I(t),t.patches_&&t.patchListener_(t.patches_,t.inversePatches_),e!==o?e:void 0}function D(e,t,o){if(S(t))return t;let r=e.immer_.shouldUseStrictIteration(),a=t[n];if(!a)return f(t,(r,n)=>N(e,a,t,r,n,o),r),t;if(a.scope_!==e)return t;if(!a.modified_)return j(e,a.base_,!0),a.base_;if(!a.finalized_){a.finalized_=!0,a.scope_.unfinalizedDrafts_--;let t=a.copy_,n=t,i=!1;3===a.type_&&(n=new Set(t),t.clear(),i=!0),f(n,(r,n)=>N(e,a,t,r,n,o,i),r),j(e,t,!1),o&&e.patches_&&C("Patches").generatePatches_(a,o,e.patches_,e.inversePatches_)}return a.copy_}function N(e,t,o,r,n,a,i){if(null==n||"object"!=typeof n&&!i)return;let u=S(n);if(!u||i){if(l(n)){let i=D(e,n,a&&t&&3!==t.type_&&!w(t.assigned_,r)?a.concat(r):void 0);if(_(o,r,i),!l(i))return;e.canAutoFreeze_=!1}else i&&o.add(n);if(s(n)&&!u){if(!e.immer_.autoFreeze_&&e.unfinalizedDrafts_<1||t&&t.base_&&t.base_[r]===n&&u)return;D(e,n),(!t||!t.scope_.parent_)&&"symbol"!=typeof r&&(h(o)?o.has(r):Object.prototype.propertyIsEnumerable.call(o,r))&&j(e,n)}}}function j(e,t,o=!1){!e.parent_&&e.immer_.autoFreeze_&&e.canAutoFreeze_&&g(t,o)}var R={get(e,t){if(t===n)return e;let o=y(e);if(!w(o,t)){var r;let n;return r=e,(n=U(o,t))?"value"in n?n.value:n.get?.call(r.draft_):void 0}let a=o[t];return e.finalized_||!s(a)?a:a===F(e.base_,t)?(W(e),e.copy_[t]=q(a,e)):a},has:(e,t)=>t in y(e),ownKeys:e=>Reflect.ownKeys(y(e)),set(e,t,o){let r=U(y(e),t);if(r?.set)return r.set.call(e.draft_,o),!0;if(!e.modified_){let r=F(y(e),t),a=r?.[n];if(a&&a.base_===o)return e.copy_[t]=o,e.assigned_[t]=!1,!0;if((o===r?0!==o||1/o==1/r:o!=o&&r!=r)&&(void 0!==o||w(e.base_,t)))return!0;W(e),L(e)}return!!(e.copy_[t]===o&&(void 0!==o||t in e.copy_)||Number.isNaN(o)&&Number.isNaN(e.copy_[t]))||(e.copy_[t]=o,e.assigned_[t]=!0,!0)},deleteProperty:(e,t)=>(void 0!==F(e.base_,t)||t in e.base_?(e.assigned_[t]=!1,W(e),L(e)):delete e.assigned_[t],e.copy_&&delete e.copy_[t],!0),getOwnPropertyDescriptor(e,t){let o=y(e),r=Reflect.getOwnPropertyDescriptor(o,t);return r?{writable:!0,configurable:1!==e.type_||"length"!==t,enumerable:r.enumerable,value:o[t]}:r},defineProperty(){a(11)},getPrototypeOf:e=>i(e.base_),setPrototypeOf(){a(12)}},x={};function F(e,t){let o=e[n];return(o?y(o):e)[t]}function U(e,t){if(!(t in e))return;let o=i(e);for(;o;){let e=Object.getOwnPropertyDescriptor(o,t);if(e)return e;o=i(o)}}function L(e){!e.modified_&&(e.modified_=!0,e.parent_&&L(e.parent_))}function W(e){e.copy_||(e.copy_=m(e.base_,e.scope_.immer_.useStrictShallowCopy_))}function q(e,o){let r=h(e)?C("MapSet").proxyMap_(e,o):v(e)?C("MapSet").proxySet_(e,o):function(e,o){let r=Array.isArray(e),n={type_:+!!r,scope_:o?o.scope_:t,modified_:!1,finalized_:!1,assigned_:{},parent_:o,base_:e,draft_:null,copy_:null,revoke_:null,isManual_:!1},a=n,i=R;r&&(a=[n],i=x);let{revoke:l,proxy:s}=Proxy.revocable(a,i);return n.draft_=s,n.revoke_=l,s}(e,o);return(o?o.scope_:t).drafts_.push(r),r}f(R,(e,t)=>{x[e]=function(){return arguments[0]=arguments[0][0],t.apply(this,arguments)}}),x.deleteProperty=function(e,t){return x.set.call(this,e,t,void 0)},x.set=function(e,t,o){return R.set.call(this,e[0],t,o,e[0])};var z=new class{constructor(e){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.useStrictIteration_=!0,this.produce=(e,t,r)=>{let n;if("function"==typeof e&&"function"!=typeof t){let o=t;t=e;let r=this;return function(e=o,...n){return r.produce(e,e=>t.call(this,e,...n))}}if("function"!=typeof t&&a(6),void 0!==r&&"function"!=typeof r&&a(7),s(e)){let o=E(this),a=q(e,void 0),i=!0;try{n=t(a),i=!1}finally{i?I(o):O(o)}return A(o,r),T(n,o)}if(e&&"object"==typeof e)a(1,e);else{if(void 0===(n=t(e))&&(n=e),n===o&&(n=void 0),this.autoFreeze_&&g(n,!0),r){let t=[],o=[];C("Patches").generateReplacementPatches_(e,n,t,o),r(t,o)}return n}},this.produceWithPatches=(e,t)=>{let o,r;return"function"==typeof e?(t,...o)=>this.produceWithPatches(t,t=>e(t,...o)):[this.produce(e,t,(e,t)=>{o=e,r=t}),o,r]},"boolean"==typeof e?.autoFreeze&&this.setAutoFreeze(e.autoFreeze),"boolean"==typeof e?.useStrictShallowCopy&&this.setUseStrictShallowCopy(e.useStrictShallowCopy),"boolean"==typeof e?.useStrictIteration&&this.setUseStrictIteration(e.useStrictIteration)}createDraft(e){var t;s(e)||a(8),l(e)&&(l(t=e)||a(10,t),e=function e(t){let o;if(!s(t)||S(t))return t;let r=t[n],a=!0;if(r){if(!r.modified_)return r.base_;r.finalized_=!0,o=m(t,r.scope_.immer_.useStrictShallowCopy_),a=r.scope_.immer_.shouldUseStrictIteration()}else o=m(t,!0);return f(o,(t,r)=>{_(o,t,e(r))},a),r&&(r.finalized_=!1),o}(t));let o=E(this),r=q(e,void 0);return r[n].isManual_=!0,O(o),r}finishDraft(e,t){let o=e&&e[n];o&&o.isManual_||a(9);let{scope_:r}=o;return A(r,t),T(void 0,r)}setAutoFreeze(e){this.autoFreeze_=e}setUseStrictShallowCopy(e){this.useStrictShallowCopy_=e}setUseStrictIteration(e){this.useStrictIteration_=e}shouldUseStrictIteration(){return this.useStrictIteration_}applyPatches(e,t){let o;for(o=t.length-1;o>=0;o--){let r=t[o];if(0===r.path.length&&"replace"===r.op){e=r.value;break}}o>-1&&(t=t.slice(o+1));let r=C("Patches").applyPatches_;return l(e)?r(e,t):this.produce(e,e=>r(e,t))}}().produce;e.s(["produce",()=>z])},414571,e=>{"use strict";let t;var o=e.i(768834),r=e.i(606368),n=e.i(601655),a=e.i(602246),i=e.i(842405),l=e.i(394073),s=e.i(709557),u=e.i(442706),c=e.i(268580);let d={isCollapsed:!1},f={initialized:!1,preloadedAttachments:void 0,workflowId:void 0,getAccessTokenSilently:void 0,workflowConversationId:void 0,activeStepId:void 0,previousStepId:void 0,hoveredCellId:void 0,focusedCellId:void 0,editedCellId:void 0,completedCount:0,cellCount:0,runningQueue:[],cells:{}},p=(0,o.create)()((t=(e,t)=>({...f,reset:()=>e(f),initCells:(t,o)=>{e(e=>{e.initialized=!0,e.workflowId=t.id,e.workflowConversationId=t.conversation_id,e.getAccessTokenSilently=o;let r=Object.keys(e.cells),n=t.plan.steps;if(!n||n.reduce((e,t)=>e&&r.some(e=>e===t.id),!0))return e;n.forEach(t=>{e.cells[t.id]||(e.cells[t.id]={...d,id:t.id})}),e.cellCount=n.length})},syncCells:t=>e(e=>{t.forEach(t=>{e.cells[t.id]||(e.cells[t.id]={...d,id:t.id})}),e.cellCount=t.length}),preloadAttachments:t=>e(e=>{e.preloadedAttachments=t}),toggleCollapse:(t,o)=>e(e=>{if("all"===t){let t=Object.values(e.cells),o=t.every(e=>e.isCollapsed);t.forEach(e=>e.isCollapsed=!o)}else"cell"===t&&(e.cells[o].isCollapsed=!e.cells[o].isCollapsed)}),stopAll:()=>{let{workflowId:e,workflowConversationId:o}=t(),{sendData:r}=s.default.getState();r("stop_all",{workflow_id:e,workflow_conversation_id:o})},runAll:({from:t,startStepId:o})=>e(e=>{let r=[],n=c.workflowService.getWorkflow(e.workflowId).plan.steps;if("previous"===t){let t=e.previousStepId||e.activeStepId,o=n.findIndex(e=>e.id===t);o=o===n.length-1?0:o,r=[...n.slice(o+1)].map(e=>e.id)}else if("beginning"===t)r=n.map(e=>e.id);else if("focused"===t){let t=n.findIndex(t=>t.id===e.focusedCellId);t>=0&&(r=n.slice(t).map(e=>e.id))}else if("step"===t&&o){let e=n.findIndex(e=>e.id===o);e>=0&&(r=n.slice(e).map(e=>e.id))}r.forEach(t=>{e.runningQueue.push(t)})}),interruptCell:t=>e(e=>{e.cells&&e.cells[t]&&(e.runningQueue=[])}),setActiveStepId:t=>e(e=>{e.previousStepId=e.activeStepId,e.activeStepId=t,e.editedCellId===t&&(e.editedCellId=void 0)}),startCell:t=>e(e=>{t!==e.activeStepId&&e.editedCellId===t&&(e.editedCellId=void 0)}),completeCell:t=>e(e=>{e.cells&&e.cells[t]&&(e.completedCount+=1)}),errorCell:t=>e(e=>{if(!e.cells||!e.cells[t])return}),moveCell:(t,o,r=1)=>e(e=>{if(!e.cells||!e.cells[t])return;let n=c.workflowService.getIndexbyStepId(e.workflowId,t);if(void 0===n)return;let a=n+("up"===o?-r:r);a>=0&&a<e.cellCount&&h(e=>({...e,steps:c.workflowService.moveStepByIndex(e.steps,n,a)}))}),focusCell:(t,o)=>e(e=>{e.focusedCellId===t&&o||e.editedCellId!==t&&(e.focusedCellId=o?t:void 0,e.editedCellId!==t&&(e.editedCellId=void 0),s.default.getState().sendData("focus_cell",{workflow_id:e.workflowId,focused_cell_id:!!o&&t}))}),hoverCell:(t,o)=>e(e=>{e.hoveredCellId===t&&o||(e.hoveredCellId=o?t:void 0)}),editCell:(t,o)=>{e(e=>{e.editedCellId===t&&o||e.activeStepId!==t&&(e.editedCellId=o?t:void 0,e.editedCellId===t&&(e.focusedCellId=t,s.default.getState().sendData("focus_cell",{workflow_id:e.workflowId,focused_cell_id:t})))})},resetCell:t=>e(e=>{if(!e.cells||!e.cells[t])return}),addToQueue:t=>e(e=>{e.runningQueue.push(t)}),popQueue:()=>e(e=>{e.runningQueue.shift()}),_updateCells:t=>e(e=>{t.forEach(t=>{e.cells[t.id]&&(e.cells[t.id]={...e.cells[t.id],...t})})}),clearAll:async()=>{let{sendData:e}=s.default.getState(),{workflowId:o,workflowConversationId:r,resetCell:n,getAccessTokenSilently:a}=t(),i=await a(),l=c.workflowService.getWorkflow(o);if(!l)return;let{plan:u}=l;for(let t of u.steps){let a=c.workflowService.getCellType(t);if("file-upload"!==a.value){if("user-prompt"===a.value){let e={content:""};h(r=>({...r,steps:c.workflowService.updateStepById(o,t.id,e)}))}e("clear_cell",{access_token:i,cell_type:a.value,workflow_id:o,workflow_conversation_id:r,workflow_step_id:t.id}),n(t.id)}}}}),(e,o,n)=>(n.setState=(t,o,...n)=>e("function"==typeof t?(0,r.produce)(t):t,o,...n),t(n.setState,o,n)))),w={sync:l.FEATURE_FLAGS.REALTIME_EDITING?"socket":"http"},_=async e=>{let{workflowConversationId:t,workflowId:o,completeCell:r,getAccessTokenSilently:n}=p.getState(),a=c.workflowService.getStepById(o,e);if(!a)return;let{sendData:i}=s.default.getState(),l=await n();r(e);let u=c.workflowService.getCellType(a);i("clear_cell",{workflow_id:o,access_token:l,workflow_conversation_id:t,workflow_step_id:a.id,cell_type:u.value}),h(t=>({...t,steps:t.steps.filter(t=>t.id!==e)}))},h=(e,t=w)=>{let{workflowId:o}=p.getState(),r=(0,a.getWorkflowQueryKey)(o),n=i.client.getQueryData(r);if(!n?.plan)return void console.error("Attempted to mutate non existent cache entry for workflowId: ",o);let l=e(n.plan),s=i.client.setQueryData(r,e=>({...e,plan:l}));if(t&&t.sync){let{sync:e}=t;v(o,n,s,e)}return s},v=async(e,t,o,r)=>{let{getAccessTokenSilently:l}=p.getState(),s=await l();try{"socket"===r?k(e,t.plan,o.plan):"http"===r&&(0,n.updateWorkflowAPI)({workflowId:e,workflowPlan:o.plan,accessToken:s})}catch(o){console.error(o),i.client.setQueryData((0,a.getWorkflowQueryKey)(e),t)}},y=0,m=0,g=()=>{let e=Date.now();return e===y?m++:(y=e,m=0),e+m/1e3},k=(e,t,o)=>{let r=u.diffEngine.diff(t,o);s.default.getState().sendData("edit",{workflow_id:e,timestamp:g(),diff:r})},S=(e=>{for(let t of(e.use={},Object.keys(e.getState())))e.use[t]=()=>e(e=>e[t]);return e})(p);e.s(["addCell",0,(e,t="ai-prompt",o={})=>{let{editCell:r}=S.getState(),n=c.workflowService.createDefaultStep(t,o);return h(t=>({...t,steps:c.workflowService.insertStepAtIndex(t.steps,n,e)})),r(n.id,!0),n},"cancelRunCell",0,e=>{let{workflowConversationId:t,workflowId:o}=p.getState(),{sendData:r}=s.default.getState(),n=c.workflowService.getStepById(o,e);r("interrupt_cell",{cell_type:c.workflowService.getCellType(n).value,workflow_id:o,workflow_conversation_id:t,workflow_step_id:e})},"default",0,S,"getUniqueTimestamp",0,g,"mutatePlan",0,h,"removeCell",0,_,"syncPlan",0,v,"updateCell",0,(e,t)=>{let{workflowId:o}=S.getState();h(r=>({...r,steps:c.workflowService.updateStepById(o,e,t)}))},"workflowEngine",0,p],414571)}]);

//# debugId=7284a8e9-fe32-0f0d-bfe4-babb4c695900
//# sourceMappingURL=95bb060e84ddcb72.js.map